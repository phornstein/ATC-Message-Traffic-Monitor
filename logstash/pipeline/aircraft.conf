input {
  http_poller {
    urls => {
      aircraft => "${AIRCRAFT_API_BASE_URL}/${ATC_LAT}/${ATC_LON}/${ATC_RADIUS_NM}"
    }
    schedule => { every => "5s" }
    codec => "json"
    metadata_target => "http_poller_metadata"
  }
}

filter {
  # Split the aircraft array into individual events
  split {
    field => "[ac]"
  }

  # Move all aircraft fields to root level
  mutate {
    rename => { "[ac]" => "[@metadata][aircraft]" }
  }

  ruby {
    code => '
      aircraft = event.get("[@metadata][aircraft]")
      if aircraft.is_a?(Hash)
        aircraft.each do |key, value|
          event.set(key, value)
        end
      end
    '
  }

  # Remove tisb and mlat fields
  mutate {
    remove_field => [ "tisb", "mlat" ]
  }

  # Create location field from lat/lon for geo_point
  if [lat] and [lon] {
    mutate {
      add_field => {
        "[location][lat]" => "%{lat}"
        "[location][lon]" => "%{lon}"
      }
    }

    # Convert to float
    mutate {
      convert => {
        "[location][lat]" => "float"
        "[location][lon]" => "float"
      }
    }
  }

  # Add timestamp
  ruby {
    code => '
      event.set("@timestamp", LogStash::Timestamp.now)
    '
  }

  # Remove metadata fields we don't need
  mutate {
    remove_field => [
      "http_poller_metadata",
      "msg",
      "total",
      "ctime",
      "ptime",
      "event",
      "acas"
    ]
  }

  # Clean up flight field (trim whitespace)
  if [flight] {
    mutate {
      strip => ["flight"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_ENDPOINT}"]
    custom_headers => {
      "Authorization" => "ApiKey ${ELASTICSEARCH_API_KEY}"
    }
    ssl_enabled => false
    # ssl_certificate_authorities => "/etc/logstash/certs/ca.crt"
    # ssl_certificate_authorities => ["/etc/ssl/certs/ca-certificates.crt"]
    data_stream => "true"
    data_stream_type => "logs"
    data_stream_dataset => "${AIRCRAFT_INDEX}"
    data_stream_namespace => "default"
  }

  # Uncomment for debugging
  # stdout { codec => rubydebug }
}
